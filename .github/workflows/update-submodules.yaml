name: Update Submodules

# References
# https://zenn.dev/ymmmtym/articles/dc741561759a49
# https://qiita.com/keiswe/items/7bcb29ea6c29d710b64b

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ åˆå‰9æ™‚ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-submodules:
    runs-on: ubuntu-latest

    steps:
    # STEP 1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    # STEP 2: ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ›´æ–°ã¨ã‚³ãƒŸãƒƒãƒˆ
    - name: Update, Commit, and Push Submodules
      run: |
        # Gitã®ç’°å¢ƒè¨­å®šã‚’èª¿æ•´ã—ã¦ã€äºˆæœŸã›ã¬ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’é˜²ãã¾ã™
        echo "ğŸ”§ Configuring git to prevent unexpected file modifications..."
        # 1. è‡ªå‹•æ”¹è¡Œã‚³ãƒ¼ãƒ‰å¤‰æ›ã‚’ç„¡åŠ¹åŒ– (CRLF/LFå•é¡Œã®é˜²æ­¢)
        git config --global core.autocrlf false
        # 2. ã€æœ€é‡è¦ã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œæ¨©é™ã®å¤‰æ›´ã‚’ç„¡è¦– (ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å•é¡Œã®è§£æ±º)
        git config --global core.filemode false

        # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã®æœ€æ–°ã«æ›´æ–°ã—ã¾ã™
        echo "ğŸ”„ Updating submodules..."
        git submodule update --init --remote --recursive

        # å¤‰æ›´ãŒãªã„å ´åˆã¯ã“ã“ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†ã—ã¾ã™
        if [ -z "$(git status --porcelain)" ]; then
          echo "âœ… No submodule changes to commit."
          exit 0
        fi

        echo "ğŸ” Submodule changes detected. Preparing to commit..."

        # Gitã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¾ã™
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã™
        echo "ğŸ“ Staging changes..."
        git add -A

        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™
        echo "ğŸ“Š Git status after staging:"
        git status

        # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™
        git commit -m "chore: Update submodules"

        # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™
        git push
